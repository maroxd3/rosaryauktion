<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Register to Bid</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/css/intlTelInput.css"
    integrity="sha512-gxWow8Mo6q6pLa1XH/CcH8JyiSDEtiwJV78E+D+QP0EVasFs8wKXq8YLAaPeJQEBVfzkh5anjqig4G4X20w5/Q=="
    crossorigin="anonymous"
  />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap');
    body {
      background:#000; color:#ffd700; font-family:'Cinzel', serif;
      display:flex; flex-direction:column; align-items:center;
      padding-top:4rem; min-height:100vh; margin:0;
    }
    h1 { font-size:2.5rem; margin-bottom:1.5rem; text-shadow:0 0 8px rgba(255,215,0,0.6); }
    form {
      display:flex; flex-direction:column; gap:1rem;
      width:90%; max-width:320px;
    }
    input, button {
      width:100%; padding:.75rem 1rem;
      border-radius:6px; outline:none;
      font-size:1rem;
    }
    input {
      border:1px solid #ffd700; background:rgba(0,0,0,0.8); color:#ffd700;
      transition:box-shadow .2s;
    }
    input:focus { box-shadow:0 0 8px rgba(255,215,0,0.8); }
    button {
      background:#ffd700; color:#000; font-weight:600;
      border:none; transition:background .2s,transform .1s;
      cursor:pointer;
    }
    button:hover { background:#ffea47; transform:translateY(-2px); }
    button:active{ transform:translateY(0); }
  </style>
</head>
<body>
  <h1>Register to Bid</h1>
  <h1 lang="ar" class="ar">سجل للمزايدة</h1>

  <form id="registerForm"
        action="https://docs.google.com/forms/d/e/1FAIpQLSfhK8x6ck1KWtyRgTrem_uMx-cuGSvnNF63wkZfX_zdleUbng/formResponse"
        method="POST"
        target="hidden_iframe"
        onsubmit="submitted=true;">
    <input
      name="entry.1409023092"
      type="text"
      placeholder="Your TikTok Alias"
      required
    >
    <input
      id="phone"
      name="entry.1749874347"
      type="tel"
      placeholder="WhatsApp Number"
      required
    >
    <button type="submit">Register</button>
  </form>

  <iframe name="hidden_iframe" style="display:none;"></iframe>

  <!-- intl-tel-input -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/js/intlTelInput.min.js"
          integrity="sha512-+gHzOStaOEgl6o3O6KEmYLrAjVvZKid6wkvGf9lBTxCaegF/WaO1PdVY8XiB32WVjU08LIGALJhH8e7dYYmvXg=="
          crossorigin="anonymous"></script>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script>
    // 1) Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCEzZsilk06LeSomZx3VlPdhQoe-GUqTuQ",
      authDomain: "rosayauktion.firebaseapp.com",
      databaseURL: "https://rosayauktion-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "rosayauktion",
      storageBucket: "rosayauktion.firebasestorage.app",
      messagingSenderId: "853081785147",
      appId: "1:853081785147:web:dd3fa69e2cff3e96a42d1e",
      measurementId: "G-8MY9PX1RNH"
    };
    firebase.initializeApp(firebaseConfig);
    // pointer to /registrations
    const regsRef = firebase.database().ref('registrations');

    // 2) intl-tel-input setup with EU focus
    const phoneInput = document.querySelector("#phone");
    const iti = window.intlTelInput(phoneInput, {
      initialCountry: "de", // Default to Germany
      preferredCountries: ["de", "at", "ch", "nl", "be", "fr", "pl", "dk", "se", "no"], // Germany and neighboring/nearby EU countries first
      onlyCountries: [
        // EU countries + nearby important ones, with Germany and neighbors prioritized
        "de", "at", "ch", "nl", "be", "fr", "pl", "dk", "se", "no", "fi", 
        "it", "es", "pt", "ie", "lu", "cz", "sk", "hu", "si", "hr", "ro", 
        "bg", "gr", "cy", "mt", "lt", "lv", "ee", "gb", "is", "li", "mc", "ad", "sm", "va"
      ],
      geoIpLookup: cb => {
        fetch("https://ipinfo.io/json")
          .then(res => res.json())
          .then(data => {
            // If detected country is in our EU list, use it; otherwise default to Germany
            const euCountries = [
              "de", "at", "ch", "nl", "be", "fr", "pl", "dk", "se", "no", "fi", 
              "it", "es", "pt", "ie", "lu", "cz", "sk", "hu", "si", "hr", "ro", 
              "bg", "gr", "cy", "mt", "lt", "lv", "ee", "gb", "is", "li", "mc", "ad", "sm", "va"
            ];
            const detectedCountry = data.country ? data.country.toLowerCase() : "de";
            cb(euCountries.includes(detectedCountry) ? detectedCountry : "de");
          })
          .catch(() => cb("de")); // Default to Germany if lookup fails
      },
      utilsScript:
        "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/js/utils.js"
    });

    // 3) On form submit: validate, push to Firebase, then let Google Form post
    const form = document.getElementById("registerForm");
    let submitted = false;

    form.addEventListener("submit", e => {
      // validate phone
      if (!iti.isValidNumber()) {
        e.preventDefault();
        alert("Please enter a valid phone number.");
        return;
      }
      const fullNumber = iti.getNumber();      // E.164 format
      phoneInput.value = fullNumber;           // overwrite for Google Form

      // gather alias
      const alias = form.querySelector('input[name="entry.1409023092"]').value.trim();

      // push into RTDB → triggers your server welcome-DM
      regsRef.push({
        alias,
        whatsapp: fullNumber,
        createdAt: Date.now()
      }).catch(err => console.error("Firebase write failed:", err));

      submitted = true;
    });

    // 4) thank-you alert & reset
    setInterval(() => {
      if (submitted) {
        alert("✅ Thanks! You're registered to bid.");
        submitted = false;
        form.reset();
        iti.setCountry("de"); // Reset to Germany
      }
    }, 300);
  </script>
</body>
</html>
