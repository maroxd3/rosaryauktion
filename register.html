<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Register to Bid</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/css/intlTelInput.css"
    crossorigin="anonymous"
  />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap');
    
    body {
      background:#000; color:#ffd700; font-family:'Cinzel', serif;
      display:flex; flex-direction:column; align-items:center;
      padding: 4rem 1rem 6rem 1rem; min-height:100vh; margin:0;
    }
    
    h1 { 
      font-size:2.5rem; margin-bottom:1.5rem; 
      text-shadow:0 0 8px rgba(255,215,0,0.6); 
    }
    
    form {
      display:flex; flex-direction:column; gap:1rem;
      width:90%; max-width:320px;
    }
    
    input, button {
      width:100%; padding:.75rem 1rem;
      border-radius:6px; outline:none;
      font-size:1rem;
    }
    
    input {
      border:1px solid #ffd700; background:rgba(0,0,0,0.8); color:#ffd700;
      transition:box-shadow .2s;
    }
    
    input:focus { box-shadow:0 0 8px rgba(255,215,0,0.8); }
    input.error { border-color: #ff4444; box-shadow:0 0 8px rgba(255,68,68,0.6); }
    
    button {
      background:#ffd700; color:#000; font-weight:600;
      border:none; transition:background .2s,transform .1s;
      cursor:pointer;
    }
    
    button:hover { background:#ffea47; transform:translateY(-2px); }
    button:active{ transform:translateY(0); }
    button:disabled { background:#666; cursor:not-allowed; transform:none; }

    .warning {
      background: rgba(255,215,0,0.1);
      border: 1px solid #ffd700;
      color: #ffd700;
      padding: 0.8rem;
      border-radius: 6px;
      font-size: 0.9rem;
      text-align: center;
      margin-bottom: 1rem;
    }

    .example {
      background: rgba(255,215,0,0.1);
      border: 1px solid #ffd700;
      padding: 0.8rem;
      border-radius: 6px;
      font-size: 0.85rem;
      margin-bottom: 1rem;
    }

    .example-title {
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .good { color: #44ff44; }
    .bad { color: #ff4444; }

    .help-text {
      font-size: 0.8rem;
      color: #ffd700;
      opacity: 0.8;
      margin-top: 0.3rem;
      text-align: left;
    }

    /* Overlay Styles */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .overlay-content {
      background: linear-gradient(135deg, rgba(0,0,0,0.95), rgba(255,215,0,0.05));
      border: 2px solid #ffd700;
      border-radius: 12px;
      padding: 2rem;
      max-width: 400px;
      width: 90%;
      text-align: center;
      box-shadow: 0 0 30px rgba(255,215,0,0.3);
      transform: scale(0.8);
      transition: transform 0.3s ease;
      position: relative;
    }

    .overlay.active .overlay-content {
      transform: scale(1);
    }

    .overlay-close {
      position: absolute;
      top: -10px;
      right: -10px;
      width: 30px;
      height: 30px;
      background: #ffd700;
      color: #000;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .overlay-close:hover {
      background: #ffea47;
      transform: scale(1.1);
    }

    .success-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
      animation: bounce 0.6s ease;
    }

    .error-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
      color: #ff4444;
      animation: shake 0.6s ease;
    }

    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-20px); }
      60% { transform: translateY(-10px); }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }

    .overlay h2 {
      color: #ffd700;
      margin-bottom: 1rem;
      font-size: 1.5rem;
    }

    .overlay p {
      color: #ffd700;
      margin-bottom: 1.5rem;
      line-height: 1.4;
    }

    .overlay-button {
      background: #ffd700;
      color: #000;
      border: none;
      padding: 0.8rem 2rem;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.2s ease;
      margin: 0.5rem;
    }

    .overlay-button:hover {
      background: #ffea47;
      transform: translateY(-2px);
    }

    .overlay-button.secondary {
      background: transparent;
      color: #ffd700;
      border: 1px solid #ffd700;
    }

    .overlay-button.secondary:hover {
      background: rgba(255,215,0,0.1);
    }

    /* Dark theme overrides for intl-tel-input dropdown */
    .iti__flag-container {
      background: #000 !important;
    }
    .iti__country-list, .iti__country-list .iti__country {
      background: #000 !important;
      color: #ffd700 !important;
    }
    .iti__country:hover, .iti__country.iti__highlight {
      background: rgba(255,215,0,0.1) !important;
    }
    .iti__country-name, .iti__dial-code {
      color: #ffd700 !important;
    }
    .iti__country-list::-webkit-scrollbar {
      width: 6px;
    }
    .iti__country-list::-webkit-scrollbar-thumb {
      background: rgba(255,215,0,0.5);
      border-radius: 3px;
    }

    /* Fix z-index for intl-tel-input dropdown to appear above overlay */
    .iti__country-list {
      z-index: 1001 !important;
    }

    .loading {
      color: #ffd700;
      opacity: 0.7;
    }
  </style>
</head>
<body>
  <h1>Register to Bid</h1>
  <h1 lang="ar" class="ar">سجل للمزايدة</h1>

  <div class="warning">
    💡 Please use your TikTok username (not your real name)<br>
    <span lang="ar">💡 يرجى استخدام اسم المستخدم في تيك توك (وليس اسمك الحقيقي)</span>
  </div>

  <div class="example">
    <div class="example-title">Examples / أمثلة:</div>
    <div class="good">✅ @user123 or user123</div>
    <div class="good">✅ @coolgamer2024</div>
    <div class="bad">❌ John Smith / أحمد محمد</div>
    <div class="bad">❌ Sarah Johnson / فاطمة علي</div>
  </div>

  <form id="registerForm"
        action="https://docs.google.com/forms/d/e/1FAIpQLSfhK8x6ck1KWtyRgTrem_uMx-cuGSvnNF63wkZfX_zdleUbng/formResponse"
        method="POST"
        target="hidden_iframe">
    <div>
      <input
        id="tiktokAlias"
        name="entry.1409023092"
        type="text"
        placeholder="@your_tiktok_username / @اسم_المستخدم_تيك_توك"
        required
      >
      <div class="help-text">
        Find your username in TikTok: Profile → Copy username<br>
        <span lang="ar">ابحث عن اسم المستخدم في تيك توك: الملف الشخصي ← نسخ اسم المستخدم</span>
      </div>
    </div>
    <input
      id="phone"
      name="entry.1749874347"
      type="tel"
      placeholder="WhatsApp Number"
      required
    >
    <button type="submit" id="submitBtn">Register</button>
  </form>

  <!-- Success Overlay -->
  <div id="successOverlay" class="overlay">
    <div class="overlay-content">
      <button class="overlay-close" onclick="closeOverlay('successOverlay')">&times;</button>
      <div class="success-icon">🎉</div>
      <h2>Registration Successful!</h2>
      <h2 lang="ar">تم التسجيل بنجاح!</h2>
      <p id="successMessage">Perfect! You're all set to bid with: <span id="registeredUsername"></span></p>
      <p lang="ar">ممتاز! أنت جاهز للمزايدة باسم: <span id="registeredUsernameAr"></span></p>
      <button class="overlay-button" onclick="closeOverlay('successOverlay')">Continue / متابعة</button>
    </div>
  </div>

  <!-- Error Overlay -->
  <div id="errorOverlay" class="overlay">
    <div class="overlay-content">
      <button class="overlay-close" onclick="closeOverlay('errorOverlay')">&times;</button>
      <div class="error-icon">⚠️</div>
      <h2>Let's Fix This!</h2>
      <h2 lang="ar">دعنا نصلح هذا!</h2>
      <p id="errorMessage">Please check your information and try again.</p>
      <div>
        <button class="overlay-button" onclick="closeOverlay('errorOverlay')">Try Again / حاول مرة أخرى</button>
        <button class="overlay-button secondary" onclick="showHelp()">Need Help? / تحتاج مساعدة؟</button>
      </div>
    </div>
  </div>

  <!-- Help Overlay -->
  <div id="helpOverlay" class="overlay">
    <div class="overlay-content">
      <button class="overlay-close" onclick="closeOverlay('helpOverlay')">&times;</button>
      <h2>How to Find Your TikTok Username</h2>
      <h2 lang="ar">كيفية العثور على اسم المستخدم في تيك توك</h2>
      <div style="text-align: left; margin: 1rem 0;">
        <p><strong>English:</strong></p>
        <ol style="color: #ffd700; margin-left: 1rem;">
          <li>Open TikTok app</li>
          <li>Go to your Profile (bottom right)</li>
          <li>Your username is at the top (starts with @)</li>
          <li>Copy it without the @ symbol</li>
        </ol>
        <p><strong lang="ar">العربية:</strong></p>
        <ol style="color: #ffd700; margin-left: 1rem;" lang="ar">
          <li>افتح تطبيق تيك توك</li>
          <li>اذهب إلى ملفك الشخصي (أسفل اليمين)</li>
          <li>اسم المستخدم في الأعلى (يبدأ بـ @)</li>
          <li>انسخه بدون رمز @</li>
        </ol>
      </div>
      <button class="overlay-button" onclick="closeOverlay('helpOverlay')">Got It! / فهمت!</button>
    </div>
  </div>

  <iframe name="hidden_iframe" style="display:none;"></iframe>

  <!-- intl-tel-input -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/js/intlTelInput.min.js"
          crossorigin="anonymous"></script>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script>
    // 1) Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCEzZsilk06LeSomZx3VlPdhQoe-GUqTuQ",
      authDomain: "rosayauktion.firebaseapp.com",
      databaseURL: "https://rosayauktion-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "rosayauktion",
      storageBucket: "rosayauktion.firebasestorage.app",
      messagingSenderId: "853081785147",
      appId: "1:853081785147:web:dd3fa69e2cff3e96a42d1e",
      measurementId: "G-8MY9PX1RNH"
    };
    firebase.initializeApp(firebaseConfig);
    const regsRef = firebase.database().ref('registrations');

    // 2) intl-tel-input setup with limited countries
    const phoneInput = document.querySelector("#phone");
    
    // Define allowed countries: EU + Arabic countries + USA + Canada + UK
    const allowedCountries = [
      // EU Countries
      'at', 'be', 'bg', 'hr', 'cy', 'cz', 'dk', 'ee', 'fi', 'fr', 'de', 'gr', 
      'hu', 'ie', 'it', 'lv', 'lt', 'lu', 'mt', 'nl', 'pl', 'pt', 'ro', 'sk', 
      'si', 'es', 'se',
      // Arabic Countries
      'ae', 'bh', 'dz', 'eg', 'iq', 'jo', 'kw', 'lb', 'ly', 'ma', 'om', 'ps', 
      'qa', 'sa', 'sd', 'sy', 'tn', 'ye',
      // Important Others
      'us', 'ca', 'gb', 'au', 'ch', 'no', 'is'
    ];
    
    const iti = window.intlTelInput(phoneInput, {
      initialCountry: "auto",
      onlyCountries: allowedCountries,
      preferredCountries: ['us', 'de', 'fr', 'gb', 'ae', 'sa', 'eg'],
      geoIpLookup: cb => {
        fetch("https://ipinfo.io/json")
          .then(res => res.json())
          .then(data => cb(data.country))
          .catch(() => cb("de"));
      },
      utilsScript:
        "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/js/utils.js"
    });

    // 3) Overlay Functions
    function showOverlay(overlayId) {
      const overlay = document.getElementById(overlayId);
      overlay.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeOverlay(overlayId) {
      const overlay = document.getElementById(overlayId);
      overlay.classList.remove('active');
      document.body.style.overflow = 'auto';
    }

    function showSuccess(username) {
      document.getElementById('registeredUsername').textContent = username;
      document.getElementById('registeredUsernameAr').textContent = username;
      showOverlay('successOverlay');
    }

    function showError(message) {
      document.getElementById('errorMessage').innerHTML = message;
      showOverlay('errorOverlay');
    }

    function showHelp() {
      closeOverlay('errorOverlay');
      showOverlay('helpOverlay');
    }

    // Close overlay when clicking outside
    document.querySelectorAll('.overlay').forEach(overlay => {
      overlay.addEventListener('click', function(e) {
        if (e.target === this) {
          closeOverlay(this.id);
        }
      });
    });

    // Close overlay with Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        document.querySelectorAll('.overlay.active').forEach(overlay => {
          closeOverlay(overlay.id);
        });
      }
    });

    // 4) TikTok username validation - MUCH MORE RELAXED
    const tiktokInput = document.getElementById('tiktokAlias');
    const submitBtn = document.getElementById('submitBtn');

    function validateTikTokUsername(username) {
      const trimmed = username.trim();
      
      if (!trimmed || trimmed.length === 0) {
        return { isValid: false, cleaned: '', isEmpty: true };
      }
      
      // Remove @ if present
      const cleaned = trimmed.startsWith('@') ? trimmed.slice(1) : trimmed;
      
      // Very basic validation - just check if it's not empty and has some basic format
      const isValidFormat = cleaned.length >= 1 && cleaned.length <= 50;
      
      // Only block if it's OBVIOUSLY a real name with very specific patterns
      const obviousRealNamePatterns = [
        /^[A-Z][a-z]+ [A-Z][a-z]+$/, // "John Smith" exactly
        /^Mr\.?\s+[A-Z][a-z]+/i, // "Mr. John"
        /^Mrs\.?\s+[A-Z][a-z]+/i, // "Mrs. Jane"
        /^Dr\.?\s+[A-Z][a-z]+/i, // "Dr. Smith"
      ];
      
      const isObviousRealName = obviousRealNamePatterns.some(pattern => pattern.test(trimmed));
      
      return {
        isValid: isValidFormat && !isObviousRealName,
        cleaned: cleaned,
        isLikelyRealName: isObviousRealName
      };
    }

    // Much more lenient real-time validation
    tiktokInput.addEventListener('input', function() {
      const validation = validateTikTokUsername(this.value);
      
      if (this.value.length > 0) {
        if (validation.isValid) {
          this.classList.remove('error');
        } else if (validation.isLikelyRealName) {
          this.classList.add('error');
        } else {
          this.classList.remove('error');
        }
      } else {
        this.classList.remove('error');
      }
    });

    // 5) Check for duplicates function - WITH TIMEOUT AND FALLBACK
    async function checkForDuplicates(username, phoneNumber) {
      try {
        // Add timeout to the Firebase call
        const timeoutPromise = new Promise((_, reject) => 
          setTimeout(() => reject(new Error('Timeout')), 5000)
        );
        
        const dataPromise = regsRef.once('value');
        
        const snapshot = await Promise.race([dataPromise, timeoutPromise]);
        const registrations = snapshot.val();
        
        if (!registrations) return { isDuplicate: false };
        
        for (let key in registrations) {
          const reg = registrations[key];
          
          // Check for username duplicate (case insensitive)
          if (reg.alias && reg.alias.toLowerCase() === username.toLowerCase()) {
            return { 
              isDuplicate: true, 
              type: 'username',
              message: `This TikTok username is already registered! 🔒<br><span lang='ar'>اسم المستخدم هذا مسجل بالفعل! 🔒</span><br><br>If this is your account, you're already registered for bidding! ✅<br><span lang='ar'>إذا كان هذا حسابك، فأنت مسجل بالفعل للمزايدة! ✅</span>`
            };
          }
          
          // Check for phone duplicate
          if (reg.whatsapp && reg.whatsapp === phoneNumber) {
            return { 
              isDuplicate: true, 
              type: 'phone',
              message: `This phone number is already registered! 📱<br><span lang='ar'>رقم الهاتف هذا مسجل بالفعل! 📱</span><br><br>Each phone number can only be used once. ⚠️<br><span lang='ar'>كل رقم هاتف يمكن استخدامه مرة واحدة فقط. ⚠️</span>`
            };
          }
        }
        
        return { isDuplicate: false };
      } catch (error) {
        console.error('Error checking duplicates:', error);
        // If duplicate check fails, allow registration to proceed
        console.warn('Duplicate check failed, allowing registration to proceed');
        return { isDuplicate: false };
      }
    }

    // 6) Form submission with better error handling
    const form = document.getElementById("registerForm");
    let isSubmitting = false;

    form.addEventListener("submit", async e => {
      e.preventDefault();
      
      if (isSubmitting) return;
      isSubmitting = true;
      
      // Update button to show loading
      const originalButtonText = submitBtn.textContent;
      submitBtn.textContent = 'Registering...';
      submitBtn.disabled = true;
      
      try {
        // Validate phone - but be more lenient
        if (!phoneInput.value.trim()) {
          showError("Please enter your phone number 📱<br><span lang='ar'>يرجى إدخال رقم الهاتف 📱</span>");
          return;
        }
        
        let fullNumber;
        try {
          if (iti.isValidNumber()) {
            fullNumber = iti.getNumber();
          } else {
            // Try to use the raw input if validation fails
            fullNumber = phoneInput.value.trim();
            console.warn('Phone validation failed, using raw input:', fullNumber);
          }
        } catch (phoneError) {
          console.error('Phone validation error:', phoneError);
          fullNumber = phoneInput.value.trim();
        }
        
        // Validate TikTok username - very lenient
        const aliasValue = tiktokInput.value;
        const validation = validateTikTokUsername(aliasValue);
        
        if (!validation.isValid) {
          if (validation.isEmpty) {
            showError("Please enter your TikTok username! 📱<br><span lang='ar'>يرجى إدخال اسم المستخدم في تيك توك! 📱</span>");
            tiktokInput.focus();
            return;
          }
          
          if (validation.isLikelyRealName) {
            showError("This looks like your real name 📝<br><span lang='ar'>هذا يبدو كاسمك الحقيقي 📝</span><br>We need your TikTok username instead (like: @user123) 📱<br><span lang='ar'>نحتاج اسم المستخدم في تيك توك بدلاً من ذلك (مثل: @user123) 📱</span>");
            tiktokInput.classList.add('error');
            return;
          }
        }

        // Prepare cleaned values
        const finalUsername = validation.cleaned.startsWith('@') ? validation.cleaned : '@' + validation.cleaned;

        // Try to check for duplicates, but don't block if it fails
        let duplicateCheck = { isDuplicate: false };
        try {
          duplicateCheck = await checkForDuplicates(finalUsername, fullNumber);
        } catch (dupError) {
          console.error('Duplicate check failed, proceeding anyway:', dupError);
        }
        
        if (duplicateCheck.isDuplicate) {
          showError(duplicateCheck.message);
          
          // Highlight the problematic field
          if (duplicateCheck.type === 'username') {
            tiktokInput.classList.add('error');
            tiktokInput.focus();
          } else if (duplicateCheck.type === 'phone') {
            phoneInput.classList.add('error');
            phoneInput.focus();
          }
          
          return;
        }

        // Update form values
        phoneInput.value = fullNumber;
        tiktokInput.value = finalUsername;

        // Try to save to Firebase, but don't block if it fails
        try {
          await regsRef.push({
            alias: finalUsername,
            whatsapp: fullNumber,
            createdAt: Date.now(),
            validated: true,
            userAgent: navigator.userAgent,
            ip: 'unknown'
          });
        } catch (firebaseError) {
          console.error('Firebase save failed, but continuing with Google Form:', firebaseError);
        }

        // Submit to Google Form
        const tempForm = form.cloneNode(true);
        document.body.appendChild(tempForm);
        tempForm.submit();
        document.body.removeChild(tempForm);
        
        // Show success
        showSuccess(finalUsername);
        
        // Reset form
        setTimeout(() => {
          form.reset();
          iti.setCountry("de");
          tiktokInput.classList.remove('error');
          phoneInput.classList.remove('error');
        }, 1000);
        
      } catch (error) {
        console.error('Registration error:', error);
        showError("Something went wrong, but your registration might have gone through. Please check or try again. 🔄<br><span lang='ar'>حدث خطأ ما، لكن تسجيلك ربما تم. يرجى التحقق أو المحاولة مرة أخرى. 🔄</span>");
      } finally {
        // Reset button
        submitBtn.textContent = originalButtonText;
        submitBtn.disabled = false;
        isSubmitting = false;
      }
    });
  </script>
</body>
</html>
